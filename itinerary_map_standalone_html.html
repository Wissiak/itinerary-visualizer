<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Itinerary Animation</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root {
      --bg: #0e1116;
      --panel: #151a23cc;
      --panel-solid: #151a23;
      --text: #e8ecf0;
      --muted: #93a1b3;
      --accent: #7dd3fc;
      --accent2: #a78bfa;
      --good: #34d399;
      --bad: #f87171;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1020 48%, #060912 100%);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"
    }

    #app {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 14px;
      height: 100%;
      padding: 14px
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .45)
    }

    .panel {
      height: 100%;
      background: var(--panel);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .panel header {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      align-items: center;
      gap: 10px
    }

    .chip {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(125, 211, 252, .12);
      border: 1px solid rgba(125, 211, 252, .4);
      color: #bfe9ff
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-left: auto
    }

    button,
    .btn {
      cursor: pointer;
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, .08);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: .15s
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, .3)
    }

    .btn-ghost {
      background: transparent
    }

    .btn-accent {
      background: linear-gradient(135deg, rgba(125, 211, 252, .25), rgba(167, 139, 250, .25));
      border-color: rgba(255, 255, 255, .14)
    }

    .content {
      padding: 10px 14px 14px;
      overflow: auto
    }

    .section {
      background: rgba(255, 255, 255, .03);
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px
    }

    .section h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #c8d6e5;
      letter-spacing: .2px
    }

    label {
      font-size: 12px;
      color: var(--muted)
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .08);
      background: #0b1220;
      color: var(--text);
      margin-top: 4px
    }

    small {
      color: var(--muted)
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .itinerary {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .stop {
      display: grid;
      grid-template-columns: 34px 1fr auto;
      gap: 10px;
      align-items: start;
      padding: 8px;
      border: 1px dashed rgba(255, 255, 255, .08);
      border-radius: 12px;
      background: rgba(255, 255, 255, .02)
    }

    .dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 800
    }

    .stop h4 {
      margin: 0;
      font-size: 14px
    }

    .stop .meta {
      font-size: 12px;
      color: var(--muted)
    }

    .stop .actions {
      display: flex;
      gap: 6px
    }

    .timeline {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .timeline input[type=range] {
      width: 100%
    }

    .footer {
      margin-top: auto;
      padding: 10px 14px;
      border-top: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      align-items: center;
      gap: 8px
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #0b1220;
      border: 1px solid rgba(255, 255, 255, .12);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px
    }

    .hint {
      font-size: 12px;
      color: var(--muted)
    }

    .badge {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .12);
      font-size: 11px
    }

    .notice {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px
    }

    /* Responsive */
    @media (max-width: 980px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 60% 40%;
      }

      .panel {
        height: 100%
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div style="position:relative">
      <div id="map"></div>
    </div>
    <aside class="panel">
      <header>
        <div class="chip">Trip Itinerary</div>
        <div class="toolbar">
          <button id="btnDemo" class="btn-accent" title="Load demo">‚ú® Demo</button>
          <button id="btnExport" title="Export itinerary">‚¨áÔ∏è Export</button>
          <button id="btnImport" class="btn-ghost" title="Import itinerary JSON">‚¨ÜÔ∏è Import</button>
        </div>
      </header>
      <div class="content">
        <div class="section">
          <h3>Add Stop</h3>
          <div class="row">
            <div>
              <label>Name
                <input id="inName" placeholder="e.g., Sushi in Shibuya" />
              </label>
            </div>
            <div>
              <label>Fly Animation Duration
                <input id="duration" type="number" min="1" value="5" default="2" />
              </label>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Emoji / Icon
                <input id="inEmoji" maxlength="4" placeholder="üóº" />
              </label>
            </div>
            <div>
              <label>Color
                <input id="inColor" type="color" value="#7dd3fc" />
              </label>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Latitude
                <input id="inLat" placeholder="click map to fill" />
              </label>
            </div>
            <div>
              <label>Longitude
                <input id="inLng" placeholder="click map to fill" />
              </label>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="btnAdd" class="btn-accent">Ôºã Add Stop</button>
            <small class="hint">Tip: click the map to set coordinates.</small>
          </div>
        </div>

        <div class="section">
          <h3>Itinerary <span id="countBadge" class="badge">0 stops</span></h3>
          <div id="itinerary" class="itinerary"></div>
          <div class="notice">Drag to reorder, or edit/delete. Paths are drawn in time order.</div>
        </div>

        <div class="section">
          <h3>Playback</h3>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="btnPlay">‚ñ∂Ô∏è Play</button>
            <button id="btnReset">üîÑ Reset Animation</button>
            <label style="display:flex;gap:8px;align-items:center">
              <input id="chkLoop" type="checkbox" checked /> Loop
            </label>
          </div>
        </div>

      </div>
      <div class="footer">
        <div class="hint">All in one HTML. Tiles ¬© OpenStreetMap contributors.</div>
      </div>
    </aside>
  </div>

  <script>
    // --- Utilities ---
    const byId = id => document.getElementById(id);

    byId('duration').value = '2';

    // --- Map init ---
    const map = L.map('map', { zoomControl: false }).setView([46.8, 8.2], 6);
    L.control.zoom({ position: 'topright' }).addTo(map);
    const tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // --- State ---
    let stops = []; // {id, name, t, emoji, color, lat, lng}
    let markers = new Map();
    let polySegments = []; // gradient segments
    let playing = false, currentLeg = -1;
    let loop = true; byId('chkLoop').addEventListener('change', e => loop = e.target.checked);

    // --- UI bindings ---
    map.on('click', e => { byId('inLat').value = e.latlng.lat.toFixed(6); byId('inLng').value = e.latlng.lng.toFixed(6); });

    byId('btnAdd').addEventListener('click', () => {
      const name = byId('inName').value.trim() || 'Untitled stop';
      const duration = parseFloat(byId('duration').value) || 2;
      const emoji = byId('inEmoji').value.trim() || 'üìç';
      const color = byId('inColor').value || '#7dd3fc';
      const lat = parseFloat(byId('inLat').value); const lng = parseFloat(byId('inLng').value);
      if (Number.isNaN(lat) || Number.isNaN(lng)) { alert('Click the map or enter coordinates.'); return; }
      addStop({ name, emoji, color, lat, lng, duration });
      // clear minimal fields except coords
      byId('inName').value = ''; byId('inEmoji').value = '';
    });

    byId('btnDemo').addEventListener('click', () => loadDemo());
    byId('btnExport').addEventListener('click', () => {
      const data = JSON.stringify(stops, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'itinerary.json' });
      a.click(); URL.revokeObjectURL(url);
    });
    byId('btnImport').addEventListener('click', () => {
      const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json,application/json';
      inp.onchange = () => {
        const file = inp.files[0]; if (!file) return;
        file.text().then(text => { try { const arr = JSON.parse(text); loadStops(arr); } catch (e) { alert('Invalid JSON.'); } });
      };
      inp.click();
    });

    byId('btnPlay').addEventListener('click', togglePlay);
    byId('btnReset').addEventListener('click', resetAnimation);

    // --- Core functions ---
    function addStop(s) {
      const id = crypto.randomUUID();
      const stop = { id, name: s.name, emoji: s.emoji || 'üìç', color: s.color || '#7dd3fc', lat: +s.lat, lng: +s.lng, duration: s.duration || 2 };
      stops.push(stop);
      renderStops();
      fitBounds();
      flyToStop(id, stop.duration);
    }

    function loadStops(arr) {
      clearAll();
      arr.forEach(addStop);
    }

    function clearAll() {
      // clear markers & paths
      stops = []; markers.forEach(m => m.remove()); markers.clear();
      polySegments.forEach(s => s.remove()); polySegments = [];
      renderStops();
    }

    function renderStops() {
      byId('countBadge').textContent = `${stops.length} stop${stops.length !== 1 ? 's' : ''}`;

      // draw markers
      stops.forEach((s, idx) => {
        let m = markers.get(s.id);
        const html = markerHTML(idx + 1, s.emoji, s.color);
        if (!m) {
          m = L.marker([s.lat, s.lng], { icon: L.divIcon({ className: 'x', html, iconSize: [36, 36], iconAnchor: [18, 18] }) }).addTo(map);
          m.on('click', () => selectStop(s.id));
          markers.set(s.id, m);
        } else {
          m.setLatLng([s.lat, s.lng]);
          m.setIcon(L.divIcon({ className: 'x', html, iconSize: [36, 36], iconAnchor: [18, 18] }));
        }
      });

      // draw gradient path by segments
      polySegments.forEach(s => s.remove()); polySegments = [];
      const pts = stops.map(s => [s.lat, s.lng]);
      if (pts.length >= 2) {
        const n = pts.length - 1;
        for (let i = 0; i < n; i++) {
          const c = lerpColor('#22d3ee', '#a78bfa', i / (n - 1 || 1));
          const seg = L.polyline([pts[i], pts[i + 1]], { color: c, weight: 6, opacity: 0.9, lineCap: 'round', dashArray: '8 8' }).addTo(map);
          polySegments.push(seg);
        }
      }

      // build list
      const list = byId('itinerary'); list.innerHTML = '';
      stops.forEach((s, idx) => {
        const el = document.createElement('div'); el.className = 'stop';
        el.draggable = true;
        el.innerHTML = `
          <div class="dot" style="background: ${hexWithAlpha(s.color, .2)}; border:2px solid ${hexWithAlpha(s.color, .9)}">${idx + 1}</div>
          <div>
            <h4>${escapeHtml(s.emoji)} ${escapeHtml(s.name)}</h4>
          </div>
          <div class="actions">
            <button title="Fly to" onclick="flyToStop('${s.id}')">üß≠</button>
            <button title="Edit" onclick="editStop('${s.id}')">‚úèÔ∏è</button>
            <button title="Delete" onclick="deleteStop('${s.id}')" style="color:#fca5a5">üóëÔ∏è</button>
          </div>`;
        // drag & drop reordering
        el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', s.id); });
        el.addEventListener('dragover', e => e.preventDefault());
        el.addEventListener('drop', e => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); moveBefore(id, s.id); });
        list.appendChild(el);
      });
    }

    function fitBounds() {
      const pts = stops.map(s => [s.lat, s.lng]);
      if (pts.length) { map.fitBounds(L.latLngBounds(pts).pad(0.2), { animate: true }); }
    }

    function moveBefore(id, beforeId) {
      const a = stops.findIndex(s => s.id === id); const b = stops.findIndex(s => s.id === beforeId); if (a < 0 || b < 0 || a === b) return;
      const [x] = stops.splice(a, 1); stops.splice(b, 0, x); renderStops();
    }

    function deleteStop(id) { const i = stops.findIndex(s => s.id === id); if (i >= 0) { const m = markers.get(id); if (m) { m.remove(); markers.delete(id); } stops.splice(i, 1); renderStops(); } }

    function editStop(id) {
      const s = stops.find(x => x.id === id); if (!s) return;
      const name = prompt('Name', s.name); if (name === null) return;
      const duration = prompt('Duration', s.duration); if (duration === null) return;
      const emoji = prompt('Emoji', s.emoji);
      const color = prompt('Color (hex)', s.color);
      Object.assign(s, { name, duration, emoji, color });
      renderStops();
    }

    function flyToStop(id, duration) { const s = stops.find(x => x.id === id); if (!s) return; map.flyTo([s.lat, s.lng], 13, { duration }); }
    function selectStop(id) { flyToStop(id); }

    function markerHTML(idx, emoji, color) {
      return `<div style="position:relative;width:32px;height:32px;border-radius:50%;background: ${hexWithAlpha(color, .18)};border:2px solid ${hexWithAlpha(color, .9)};display:grid;place-items:center;backdrop-filter: blur(2px)">
        <div style="position:absolute;top:-8px;left:-8px;background:#0b1220;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:0 5px;font-size:11px">${idx}</div>
        <span style="font-size:16px">${escapeHtml(emoji || 'üìç')}</span>
      </div>`;
    }

    function hexWithAlpha(hex, a) {
      const { r, g, b } = hexToRgb(hex); return `rgba(${r},${g},${b},${a})`;
    }
    function hexToRgb(hex) {
      hex = hex.replace('#', ''); if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
      const num = parseInt(hex, 16); return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
    }
    function lerpColor(a, b, t) {
      const A = hexToRgb(a), B = hexToRgb(b); const r = Math.round(A.r + (B.r - A.r) * t), g = Math.round(A.g + (B.g - A.g) * t), b2 = Math.round(A.b + (B.b - A.b) * t); return `rgb(${r},${g},${b2})`;
    }
    function escapeHtml(s) { return (s + "").replace(/[&<>"]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;" }[m])); }

    // --- Playback ---

    function togglePlay() {
      if (playing) { pause(); } else { play(); }
    }
    function resetAnimation() {
      pause();
      currentLeg = -1;
      fitBounds();
    }
    function play() {
      if (stops.length < 2) { alert('Add at least two stops to play the animation.'); return; }
      playing = true; byId('btnPlay').textContent = '‚è∏Ô∏è Pause';
      fitBounds();
      recursivePlay();
    }
    function recursivePlay() {
      currentLeg += 1;
      const stop = stops[currentLeg];
      const duration = stop.duration || 2;
      flyToStop(stop.id, duration);
      if (currentLeg >= stops.length - 1) {
        currentLeg = -1;
        if (!loop) { pause(); return; }
      }
      setTimeout(() => {
        if (!playing) return;
        recursivePlay();
      }, duration * 1000 + 1000);
    }
    function pause() { playing = false; byId('btnPlay').textContent = '‚ñ∂Ô∏è Play'; }

    function interpolate(a, b, t) { return { lat: a.lat + (b.lat - a.lat) * t, lng: a.lng + (b.lng - a.lng) * t }; }

    // --- Demo data ---
    function loadDemo() {
      const demo = [
        { name: 'Arrive Z√ºrich', emoji: '‚òïÔ∏è', color: '#22d3ee', lat: 47.3779, lng: 8.5402, duration: 5 },
        { name: 'Train to Lucerne', emoji: 'üåâ', color: '#38bdf8', lat: 47.0502, lng: 8.3093, duration: 1 },
        { name: 'Boat on Lake Lucerne', emoji: 'üõ•Ô∏è', color: '#60a5fa', lat: 46.9946, lng: 8.3443, duration: 3 },
        { name: 'Overnight Interlaken', emoji: 'üåÑ', color: '#818cf8', lat: 46.6863, lng: 7.8632, duration: 2 },
        { name: 'Jungfraujoch day trip', emoji: 'üèîÔ∏è', color: '#a78bfa', lat: 46.5476, lng: 7.9850, duration: 2 }
      ];
      loadStops(demo);
      fitBounds();
    }

    // Load from URL hash if present
    (function () {
      if (location.hash.startsWith('#data=')) {
        try { const json = atob(decodeURIComponent(location.hash.slice(6))); const arr = JSON.parse(json); loadStops(arr); fitBounds(); } catch (e) { console.warn('bad hash'); }
      }
    })();

    // Expose minimal helpers to window (for inline onclick)
    window.flyToStop = flyToStop;
    window.editStop = editStop;
    window.deleteStop = deleteStop;

  </script>
</body>

</html>