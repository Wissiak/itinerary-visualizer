<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Itinerary Map ‚Äì POV Timeline</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root {
      --bg: #0e1116;
      --panel: #151a23cc;
      --panel-solid: #151a23;
      --text: #e8ecf0;
      --muted: #93a1b3;
      --accent: #7dd3fc;
      --accent2: #a78bfa;
      --good: #34d399;
      --bad: #f87171;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1020 48%, #060912 100%);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"
    }

    #app {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 14px;
      height: 100%;
      padding: 14px
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .45)
    }

    .panel {
      height: 100%;
      background: var(--panel);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .panel header {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      align-items: center;
      gap: 10px
    }

    .chip {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(125, 211, 252, .12);
      border: 1px solid rgba(125, 211, 252, .4);
      color: #bfe9ff
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-left: auto
    }

    button,
    .btn {
      cursor: pointer;
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, .08);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: .15s
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, .3)
    }

    .btn-ghost {
      background: transparent
    }

    .btn-accent {
      background: linear-gradient(135deg, rgba(125, 211, 252, .25), rgba(167, 139, 250, .25));
      border-color: rgba(255, 255, 255, .14)
    }

    .content {
      padding: 10px 14px 14px;
      overflow: auto
    }

    .section {
      background: rgba(255, 255, 255, .03);
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px
    }

    .section h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #c8d6e5;
      letter-spacing: .2px
    }

    label {
      font-size: 12px;
      color: var(--muted)
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .08);
      background: #0b1220;
      color: var(--text);
      margin-top: 4px
    }

    small {
      color: var(--muted)
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .itinerary {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .stop {
      display: grid;
      grid-template-columns: 34px 1fr auto;
      gap: 10px;
      align-items: start;
      padding: 8px;
      border: 1px dashed rgba(255, 255, 255, .08);
      border-radius: 12px;
      background: rgba(255, 255, 255, .02)
    }

    .dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 800
    }

    .stop h4 {
      margin: 0;
      font-size: 14px
    }

    .stop .meta {
      font-size: 12px;
      color: var(--muted)
    }

    .stop .actions {
      display: flex;
      gap: 6px
    }

    .timeline {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .timeline input[type=range] {
      width: 100%
    }

    .footer {
      margin-top: auto;
      padding: 10px 14px;
      border-top: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      align-items: center;
      gap: 8px
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #0b1220;
      border: 1px solid rgba(255, 255, 255, .12);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px
    }

    .hint {
      font-size: 12px;
      color: var(--muted)
    }

    .badge {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .12);
      font-size: 11px
    }

    .notice {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px
    }

    /* POV vignette */
    .vignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(650px 350px at 50% 60%, transparent 30%, rgba(0, 0, 0, .25) 65%, rgba(0, 0, 0, .45) 100%);
      mix-blend-mode: multiply;
      opacity: 0;
      transition: opacity .3s
    }

    .vignette.on {
      opacity: 1
    }

    /* Responsive */
    @media (max-width: 980px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 60% 40%;
      }

      .panel {
        height: 100%
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div style="position:relative">
      <div id="map"></div>
      <div id="vignette" class="vignette"></div>
    </div>
    <aside class="panel">
      <header>
        <div class="chip">POV Trip Itinerary</div>
        <div class="toolbar">
          <button id="btnDemo" class="btn-accent" title="Load demo">‚ú® Demo</button>
          <button id="btnExport" title="Export itinerary">‚¨áÔ∏è Export</button>
          <button id="btnImport" class="btn-ghost" title="Import itinerary JSON">‚¨ÜÔ∏è Import</button>
        </div>
      </header>
      <div class="content">
        <div class="section">
          <h3>Add Stop</h3>
          <div class="row">
            <div>
              <label>Name
                <input id="inName" placeholder="e.g., Sushi in Shibuya" />
              </label>
            </div>
            <div>
              <label>Date & Time
                <input id="inTime" type="datetime-local" />
              </label>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Emoji / Icon
                <input id="inEmoji" maxlength="4" placeholder="üóº" />
              </label>
            </div>
            <div>
              <label>Color
                <input id="inColor" type="color" value="#7dd3fc" />
              </label>
            </div>
          </div>
          <label>Notes
            <textarea id="inNotes" rows="2" placeholder="Optional: what happens here?"></textarea>
          </label>
          <div class="row">
            <div>
              <label>Latitude
                <input id="inLat" placeholder="click map to fill" />
              </label>
            </div>
            <div>
              <label>Longitude
                <input id="inLng" placeholder="click map to fill" />
              </label>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="btnAdd" class="btn-accent">Ôºã Add Stop</button>
            <small class="hint">Tip: click the map to set coordinates.</small>
          </div>
        </div>

        <div class="section">
          <h3>Itinerary <span id="countBadge" class="badge">0 stops</span></h3>
          <div id="itinerary" class="itinerary"></div>
          <div class="notice">Drag to reorder, or edit/delete. Paths are drawn in time order.</div>
        </div>

        <div class="section">
          <h3>Playback</h3>
          <div class="timeline">
            <button id="btnPlay">‚ñ∂Ô∏è Play</button>
            <input id="slider" type="range" min="0" max="1000" value="0" />
            <div id="timeLabel" class="badge">--:--</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label style="display:flex;gap:8px;align-items:center">
              <input id="chkPOV" type="checkbox" /> First-person (follow me)
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input id="chkLoop" type="checkbox" checked /> Loop
            </label>
            <div class="hint" style="margin-left:auto">Keyboard: <span class="kbd">Space</span> play/pause ‚Ä¢ <span
                class="kbd">‚Üê/‚Üí</span> scrub</div>
          </div>
        </div>

      </div>
      <div class="footer">
        <div class="hint">All in one HTML. Tiles ¬© OpenStreetMap contributors.</div>
      </div>
    </aside>
  </div>

  <script>
    // --- Utilities ---
    const byId = id => document.getElementById(id);
    function fmtDate(dt) {
      if (!dt) return '‚Äî';
      try { const d = new Date(dt); return d.toLocaleString(); } catch (e) { return dt }
    }
    function haversine(a, b) {
      const R = 6371000; const toRad = x => x * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLng / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
      return R * c;
    }
    function bearing(a, b) {
      const toRad = x => x * Math.PI / 180, toDeg: x=> x * 180 / Math.PI;
      const y = Math.sin(toRad(b.lng - a.lng)) * Math.cos(toRad(b.lat));
      const x = Math.cos(toRad(a.lat)) * Math.sin(toRad(b.lat)) -
        Math.sin(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.cos(toRad(b.lng - a.lng));
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }
    function destPoint(start, brng, dist) {
      const R = 6371000; const Œ¥ = dist / R; const Œ∏ = brng * Math.PI / 180; const œÜ1 = start.lat * Math.PI / 180; const Œª1 = start.lng * Math.PI / 180;
      const sinœÜ1 = Math.sin(œÜ1), cosœÜ1 = Math.cos(œÜ1), sinŒ¥ = Math.sin(Œ¥), cosŒ¥ = Math.cos(Œ¥), sinŒ∏ = Math.sin(Œ∏), cosŒ∏ = Math.cos(Œ∏);
      const sinœÜ2 = sinœÜ1 * cosŒ¥ + cosœÜ1 * sinŒ¥ * cosŒ∏;
      const œÜ2 = Math.asin(sinœÜ2);
      const y = sinŒ∏ * sinŒ¥ * cosœÜ1;
      const x = cosŒ¥ - sinœÜ1 * sinœÜ2;
      const Œª2 = Œª1 + Math.atan2(y, x);
      return { lat: œÜ2 * 180 / Math.PI, lng: ((Œª2 * 180 / Math.PI + 540) % 360) - 180 };
    }

    // --- Map init ---
    const map = L.map('map', { zoomControl: false }).setView([46.8, 8.2], 6);
    L.control.zoom({ position: 'topright' }).addTo(map);
    const tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // POV vignette toggle
    const vignette = byId('vignette');

    // --- State ---
    let stops = []; // {id, name, t, notes, emoji, color, lat, lng}
    let markers = new Map();
    let polySegments = []; // gradient segments
    let povMarker = null, povCone = null; // moving marker + FOV
    let playing = false, t0 = 0, playRAF = null; // animation
    let loop = true; byId('chkLoop').addEventListener('change', e => loop = e.target.checked);

    // --- UI bindings ---
    map.on('click', e => { byId('inLat').value = e.latlng.lat.toFixed(6); byId('inLng').value = e.latlng.lng.toFixed(6); });

    byId('btnAdd').addEventListener('click', () => {
      const name = byId('inName').value.trim() || 'Untitled stop';
      const t = byId('inTime').value;
      const notes = byId('inNotes').value.trim();
      const emoji = byId('inEmoji').value.trim() || 'üìç';
      const color = byId('inColor').value || '#7dd3fc';
      const lat = parseFloat(byId('inLat').value); const lng = parseFloat(byId('inLng').value);
      if (Number.isNaN(lat) || Number.isNaN(lng)) { alert('Click the map or enter coordinates.'); return; }
      addStop({ name, t, notes, emoji, color, lat, lng });
      // clear minimal fields except coords
      byId('inName').value = ''; byId('inNotes').value = ''; byId('inEmoji').value = '';
    });

    byId('btnDemo').addEventListener('click', () => loadDemo());
    byId('btnExport').addEventListener('click', () => {
      const data = JSON.stringify(stops, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'itinerary.json' });
      a.click(); URL.revokeObjectURL(url);
    });
    byId('btnImport').addEventListener('click', () => {
      const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json,application/json';
      inp.onchange = () => {
        const file = inp.files[0]; if (!file) return;
        file.text().then(text => { try { const arr = JSON.parse(text); loadStops(arr); } catch (e) { alert('Invalid JSON.'); } });
      };
      inp.click();
    });

    byId('btnPlay').addEventListener('click', togglePlay);
    byId('chkPOV').addEventListener('change', e => {
      if (e.target.checked) { vignette.classList.add('on'); ensurePOV(); } else { vignette.classList.remove('on'); clearPOV(); }
    });

    const slider = byId('slider');
    slider.addEventListener('input', () => { scrubTo(slider.value / 1000); });
    document.addEventListener('keydown', e => {
      if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
      if (e.code === 'ArrowRight') { e.preventDefault(); slider.value = Math.min(1000, parseInt(slider.value) + 20); slider.dispatchEvent(new Event('input')); }
      if (e.code === 'ArrowLeft') { e.preventDefault(); slider.value = Math.max(0, parseInt(slider.value) - 20); slider.dispatchEvent(new Event('input')); }
    });

    // --- Core functions ---
    function addStop(s) {
      const id = crypto.randomUUID();
      const tNum = s.t ? new Date(s.t).getTime() : NaN;
      const stop = { id, name: s.name, t: s.t || '', tNum, notes: s.notes || '', emoji: s.emoji || 'üìç', color: s.color || '#7dd3fc', lat: +s.lat, lng: +s.lng };
      stops.push(stop);
      renderStops();
      fitBounds();
    }

    function loadStops(arr) {
      clearAll();
      arr.forEach(addStop);
    }

    function clearAll() {
      // clear markers & paths
      stops = []; markers.forEach(m => m.remove()); markers.clear();
      if (povMarker) { povMarker.remove(); povMarker = null }
      if (povCone) { povCone.remove(); povCone = null }
      polySegments.forEach(s => s.remove()); polySegments = [];
      renderStops();
    }

    function renderStops() {
      // sort by time (keeping those without time at end)
      stops.sort((a, b) => {
        if (Number.isNaN(a.tNum) && Number.isNaN(b.tNum)) return 0;
        if (Number.isNaN(a.tNum)) return 1; if (Number.isNaN(b.tNum)) return -1;
        return a.tNum - b.tNum;
      });
      byId('countBadge').textContent = `${stops.length} stop${stops.length !== 1 ? 's' : ''}`;

      // draw markers
      stops.forEach((s, idx) => {
        let m = markers.get(s.id);
        const html = markerHTML(idx + 1, s.emoji, s.color);
        if (!m) {
          m = L.marker([s.lat, s.lng], { icon: L.divIcon({ className: 'x', html, iconSize: [36, 36], iconAnchor: [18, 18] }) }).addTo(map);
          m.on('click', () => selectStop(s.id));
          markers.set(s.id, m);
        } else {
          m.setLatLng([s.lat, s.lng]);
          m.setIcon(L.divIcon({ className: 'x', html, iconSize: [36, 36], iconAnchor: [18, 18] }));
        }
      });

      // draw gradient path by segments
      polySegments.forEach(s => s.remove()); polySegments = [];
      const pts = stops.filter(s => !Number.isNaN(s.tNum)).map(s => [s.lat, s.lng]);
      if (pts.length >= 2) {
        const n = pts.length - 1;
        for (let i = 0; i < n; i++) {
          const c = lerpColor('#22d3ee', '#a78bfa', i / (n - 1 || 1));
          const seg = L.polyline([pts[i], pts[i + 1]], { color: c, weight: 6, opacity: 0.9, lineCap: 'round', dashArray: i % 2 ? null : '8 8' }).addTo(map);
          polySegments.push(seg);
        }
      }

      // build list
      const list = byId('itinerary'); list.innerHTML = '';
      stops.forEach((s, idx) => {
        const el = document.createElement('div'); el.className = 'stop';
        el.draggable = true;
        el.innerHTML = `
          <div class="dot" style="background: ${hexWithAlpha(s.color, .2)}; border:2px solid ${hexWithAlpha(s.color, .9)}">${idx + 1}</div>
          <div>
            <h4>${escapeHtml(s.emoji)} ${escapeHtml(s.name)}</h4>
            <div class="meta">${s.t ? fmtDate(s.t) : 'No time'} ‚Ä¢ ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}</div>
            ${s.notes ? `<div class="meta">${escapeHtml(s.notes)}</div>` : ''}
          </div>
          <div class="actions">
            <button title="Fly to" onclick="flyToStop('${s.id}')">üß≠</button>
            <button title="Edit" onclick="editStop('${s.id}')">‚úèÔ∏è</button>
            <button title="Delete" onclick="deleteStop('${s.id}')" style="color:#fca5a5">üóëÔ∏è</button>
          </div>`;
        // drag & drop reordering
        el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', s.id); });
        el.addEventListener('dragover', e => e.preventDefault());
        el.addEventListener('drop', e => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); moveBefore(id, s.id); });
        list.appendChild(el);
      });

      // update slider range based on time span
      updateTimelineMeta();
    }

    function updateTimelineMeta() {
      const timed = stops.filter(s => !Number.isNaN(s.tNum));
      if (timed.length < 2) { byId('timeLabel').textContent = ''; return; }
      const start = timed[0].tNum, end = timed[timed.length - 1].tNum; const span = end - start;
      slider.disabled = span <= 0; slider.value = slider.value || 0;
      byId('timeLabel').textContent = new Date(start).toLocaleDateString();
    }

    function fitBounds() {
      const pts = stops.map(s => [s.lat, s.lng]);
      if (pts.length) { map.fitBounds(L.latLngBounds(pts).pad(0.2), { animate: true }); }
    }

    function moveBefore(id, beforeId) {
      const a = stops.findIndex(s => s.id === id); const b = stops.findIndex(s => s.id === beforeId); if (a < 0 || b < 0 || a === b) return;
      const [x] = stops.splice(a, 1); stops.splice(b, 0, x); renderStops();
    }

    function deleteStop(id) { const i = stops.findIndex(s => s.id === id); if (i >= 0) { const m = markers.get(id); if (m) { m.remove(); markers.delete(id); } stops.splice(i, 1); renderStops(); } }

    function editStop(id) {
      const s = stops.find(x => x.id === id); if (!s) return;
      const name = prompt('Name', s.name); if (name === null) return;
      const t = prompt('Date/time (YYYY-MM-DDTHH:MM)', s.t);
      const notes = prompt('Notes', s.notes);
      const emoji = prompt('Emoji', s.emoji);
      const color = prompt('Color (hex)', s.color);
      Object.assign(s, { name, t, tNum: t ? new Date(t).getTime() : NaN, notes, emoji, color });
      renderStops();
    }

    function flyToStop(id) { const s = stops.find(x => x.id === id); if (!s) return; map.flyTo([s.lat, s.lng], 13, { duration: 1.2 }); }
    function selectStop(id) { flyToStop(id); }

    function ensurePOV() {
      if (!stops.length) return;
      if (!povMarker) {
        const icon = L.divIcon({ className: 'x', html: povHTML(), iconSize: [34, 34], iconAnchor: [17, 17] });
        povMarker = L.marker([stops[0].lat, stops[0].lng], { icon }).addTo(map);
      }
      if (!povCone) { povCone = L.polygon([[0, 0], [0, 0], [0, 0]], { color: '#ffffff88', weight: 2, fillColor: '#ffffff22', fillOpacity: 0.25, opacity: 0.8 }).addTo(map); }
    }
    function clearPOV() { if (povMarker) { povMarker.remove(); povMarker = null } if (povCone) { povCone.remove(); povCone = null } }

    function povHTML() {
      return `<div style="width:30px;height:30px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #fff, #c7d2fe 35%, #6366f1 65%);box-shadow:0 0 16px rgba(99,102,241,.6), inset 0 0 12px rgba(0,0,0,.35);">
        <div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid #0f172a; transform:translateY(-2px)"></div>
      </div>`;
    }

    function markerHTML(idx, emoji, color) {
      return `<div style="position:relative;width:32px;height:32px;border-radius:50%;background: ${hexWithAlpha(color, .18)};border:2px solid ${hexWithAlpha(color, .9)};display:grid;place-items:center;backdrop-filter: blur(2px)">
        <div style="position:absolute;top:-8px;left:-8px;background:#0b1220;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:0 5px;font-size:11px">${idx}</div>
        <span style="font-size:16px">${escapeHtml(emoji || 'üìç')}</span>
      </div>`;
    }

    function hexWithAlpha(hex, a) {
      const { r, g, b } = hexToRgb(hex); return `rgba(${r},${g},${b},${a})`;
    }
    function hexToRgb(hex) {
      hex = hex.replace('#', ''); if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
      const num = parseInt(hex, 16); return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
    }
    function lerpColor(a, b, t) {
      const A = hexToRgb(a), B = hexToRgb(b); const r = Math.round(A.r + (B.r - A.r) * t), g = Math.round(A.g + (B.g - A.g) * t), b2 = Math.round(A.b + (B.b - A.b) * t); return `rgb(${r},${g},${b2})`;
    }
    function escapeHtml(s) { return (s + "").replace(/[&<>"]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;" }[m])); }

    // --- Playback ---
    function timelineMeta() {
      const timed = stops.filter(s => !Number.isNaN(s.tNum));
      if (timed.length < 2) return null;
      const start = timed[0].tNum, end = timed[timed.length - 1].tNum, span = end - start;
      return { timed, start, end, span };
    }

    function togglePlay() {
      if (playing) { pause(); } else { play(); }
    }
    function play() { if (!timelineMeta()) return; playing = true; byId('btnPlay').textContent = '‚è∏Ô∏è Pause'; t0 = performance.now() - (slider.value / 1000) * (timelineMeta().span); loopTick(); }
    function pause() { playing = false; byId('btnPlay').textContent = '‚ñ∂Ô∏è Play'; cancelAnimationFrame(playRAF); }

    function loopTick(now) {
      const meta = timelineMeta(); if (!meta) { pause(); return; }
      const { start, span } = meta;
      const elapsed = (performance.now() - t0);
      let frac = Math.min(1, Math.max(0, elapsed / span));
      scrubTo(frac);
      if (frac >= 1) { if (loop) { t0 = performance.now(); } else { pause(); return; } }
      if (playing) playRAF = requestAnimationFrame(loopTick);
    }

    function scrubTo(frac) {
      const meta = timelineMeta(); if (!meta) return;
      const { timed, start, end, span } = meta;
      const targetTime = start + frac * span; slider.value = Math.round(frac * 1000);
      byId('timeLabel').textContent = new Date(targetTime).toLocaleString();

      // find current leg
      let i = 0; while (i < timed.length - 1 && targetTime > timed[i + 1].tNum) i++;
      const A = timed[i], B = timed[Math.min(i + 1, timed.length - 1)];
      const legSpan = Math.max(1, (B.tNum - A.tNum));
      const legFrac = Math.min(1, Math.max(0, (targetTime - A.tNum) / legSpan));

      const pos = interpolate({ lat: A.lat, lng: A.lng }, { lat: B.lat, lng: B.lng }, legFrac);

      // ensure POV artifacts exist
      if (byId('chkPOV').checked) {
        ensurePOV(); if (povMarker) { povMarker.setLatLng(pos); }
        // heading + cone
        const hdg = bearing(A, B);
        if (povMarker) { povMarker.setIcon(L.divIcon({ className: 'x', html: povHTML(), iconSize: [34, 34], iconAnchor: [17, 17] })); }
        if (povCone) {
          const spanM = Math.max(150, Math.min(1500, haversine(A, B) * 0.3));
          const left = destPoint(pos, hdg - 30, spanM);
          const fwd = destPoint(pos, hdg, spanM);
          const right = destPoint(pos, hdg + 30, spanM);
          povCone.setLatLngs([[pos.lat, pos.lng], [left.lat, left.lng], [fwd.lat, fwd.lng], [right.lat, right.lng]]);
        }
        map.panTo(pos, { animate: false });
      }
    }

    function interpolate(a, b, t) { return { lat: a.lat + (b.lat - a.lat) * t, lng: a.lng + (b.lng - a.lng) * t }; }

    // --- Demo data ---
    function loadDemo() {
      const demo = [
        { name: 'Arrive Z√ºrich', t: '2025-09-08T09:00', notes: 'Coffee at HB', emoji: '‚òïÔ∏è', color: '#22d3ee', lat: 47.3779, lng: 8.5402 },
        { name: 'Train to Lucerne', t: '2025-09-08T11:10', notes: 'Walk the Kapellbr√ºcke', emoji: 'üåâ', color: '#38bdf8', lat: 47.0502, lng: 8.3093 },
        { name: 'Boat on Lake Lucerne', t: '2025-09-08T14:00', notes: 'Views of Pilatus', emoji: 'üõ•Ô∏è', color: '#60a5fa', lat: 46.9946, lng: 8.3443 },
        { name: 'Overnight Interlaken', t: '2025-09-08T19:30', notes: 'Harder Kulm sunset', emoji: 'üåÑ', color: '#818cf8', lat: 46.6863, lng: 7.8632 },
        { name: 'Jungfraujoch day trip', t: '2025-09-09T09:00', notes: 'Top of Europe', emoji: 'üèîÔ∏è', color: '#a78bfa', lat: 46.5476, lng: 7.9850 }
      ];
      loadStops(demo);
      fitBounds();
    }

    // Load from URL hash if present
    (function () {
      if (location.hash.startsWith('#data=')) {
        try { const json = atob(decodeURIComponent(location.hash.slice(6))); const arr = JSON.parse(json); loadStops(arr); fitBounds(); } catch (e) { console.warn('bad hash'); }
      }
    })();

    // Expose minimal helpers to window (for inline onclick)
    window.flyToStop = flyToStop;
    window.editStop = editStop;
    window.deleteStop = deleteStop;

  </script>
</body>

</html>